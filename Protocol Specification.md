[English Version](Protocol%20Specification.en.md)

本作品采用 [知识共享署名-非商业性使用 4.0 国际 (CC BY-NC 4.0)](https://creativecommons.org/licenses/by-nc/4.0/deed.zh) 协议授权。允许他人免费非商业性使用、改编和传播作品，但必须**清晰标注原作者署名**，且**禁止任何商业用途**（如销售、广告、盈利项目等），修改后的衍生作品也需遵循相同条款（署名+非商用），商业使用需额外获得授权。详见LICENSE文件。

------

# 协议对比与应用场景详解

## 1. ICMP（Ping协议）

### 原理

通过发送 **ICMP Echo Request** 包到目标主机，并接收 **ICMP Echo Reply** 包，测量网络层的基础延迟和连通性。

### 优点

- **简单快速**：几乎所有操作系统和网络设备均支持 ICMP。
- **轻量级**：无需建立复杂连接，开销极低。
- **网络层直达**：直接反映网络路径质量（如路由延迟、丢包率）。

### 缺点

- **非业务流量**：测的是"到服务器的网络延迟"，而非"DNS解析延迟"。
- **易被限制**：许多防火墙或 DNS 服务器会主动丢弃 ICMP 包（如 Cloudflare 默认屏蔽 ICMP）。
- **数据片面**：仅反映网络层状态，无法体现应用层（DNS）的真实性能。

### 适用场景

- **网络连通性检查**：快速验证服务器是否在线或网络是否可达。
- **基础延迟测量**：粗略评估网络路径质量（如跨地域骨干网延迟）。
- **故障排查**：定位网络中断或路由异常问题。

## 2. UDP（标准DNS查询协议）

### 原理

向 DNS 服务器的 **UDP 53 端口** 发送标准 DNS 查询请求（如 A/AAAA 记录），测量从发送请求到接收响应的完整时间。

### 优点

- **真实业务模拟**：直接测量 DNS 解析的端到端延迟，反映实际用户体验。
- **广泛兼容性**：99% 的 DNS 服务器支持 UDP 查询（RFC 标准）。
- **高效性**：UDP 无连接特性使其延迟通常低于 TCP。

### 缺点

- **端口屏蔽风险**：部分严格网络环境（如企业防火墙）可能阻断 UDP 53 端口。
- **丢包歧义**：无法区分丢包是源自网络问题还是服务器未响应。
- **数据包限制**：UDP 报文大小受限（通常 512 字节），不适合传输大型 DNS 响应。

### 适用场景

- **DNS性能基准测试**：准确评估 DNS 服务器的解析速度（如公共 DNS 对比）。
- **用户体验模拟**：测量真实业务场景下的响应延迟（如网站访问前的 DNS 解析）。
- **常规监控**：长期跟踪 DNS 服务的可用性与稳定性。

## 3. TCP（DNS over TCP/DoT）

### 原理

通过 TCP 协议与 DNS 服务器的 **53 端口** 建立连接（三次握手），发送 DNS 查询并测量响应时间。部分场景可能涉及加密（如 DoT）。

### 优点

- **可靠性**：TCP 的重传机制可确保大报文（如 DNSSEC 响应）的完整传输。
- **绕过限制**：在 UDP 53 端口被封锁时，TCP 可作为备用方案。
- **安全性**：支持 DoT（DNS over TLS）等加密协议，防止数据篡改与监听。

### 缺点

- **延迟较高**：三次握手和连接维护增加了额外开销。
- **非主流查询方式**：95% 以上的 DNS 查询默认使用 UDP。
- **测试局限性**：仅测量 TCP 握手和端口可达性，不代表 DNS 解析效率。

### 适用场景

- **大报文传输**：需要获取大型 DNS 响应（如启用 DNSSEC 时）。
- **网络限制规避**：在 UDP 53 端口被屏蔽的环境中使用（如某些公共 Wi-Fi）。
- **安全需求**：企业内网或隐私敏感场景下使用 DoT/DoH 加密通信。

## 总结与建议

| 协议 | 核心能力               | 推荐用途                               |
| ---- | ---------------------- | -------------------------------------- |
| ICMP | 网络层连通性与基础延迟 | 快速排查网络中断或路由问题             |
| UDP  | 真实 DNS 解析性能      | 评估 DNS 服务器响应速度与用户体验      |
| TCP  | 可靠性与加密通信       | 特殊场景（大报文、端口封锁、安全需求） |

- **优先选择 UDP**：若目标是测量真实 DNS 解析延迟，UDP 是最佳选择。
- **备用方案 ICMP**：仅需粗略网络质量数据时使用，需注意结果可能被过滤。
- **特殊需求 TCP**：仅在 UDP 不可用、需要加密或传输大报文时启用。

## 推荐配置

- protocol_type: "UDP"（并确保用标准DNS查询包）
- 如果UDP被封锁，才考虑用ICMP或TCP。

## 文件说明

1. **结构优化**：通过表格和分段标题增强可读性，明确区分原理、优缺点及场景。
2. **场景扩展**：新增实际案例（如 DNSSEC、企业防火墙），帮助用户理解技术细节。
3. **配置示例**：提供 YAML 格式的配置模板，直接指导实践应用。
4. **安全性补充**：强调 DoT/DoH 在隐私保护中的作用，贴合现代网络安全需求。

## 作者信息

- **作者**：兰宏（LanHong）
- **联系方式**：[xyz9010@outlook.com](mailto:xyz9010@outlook.com)

